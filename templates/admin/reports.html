{% extends "base.html" %}

{% block title %}System Reports - Admin Panel{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
            System Reports & Analytics
        </h1>
        <p class="text-gray-600">Comprehensive overview of system usage, compliance progress, and organizational metrics.</p>
    </div>

    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-white text-lg"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Users</dt>
                            <dd class="text-2xl font-bold text-gray-900">{{ total_users }}</dd>
                        </dl>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-arrow-up text-green-500 text-sm"></i>
                        </div>
                        <div class="ml-1 text-sm text-gray-600">
                            Active organizations
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-list-check text-white text-lg"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Requirements</dt>
                            <dd class="text-2xl font-bold text-gray-900">{{ total_requirements }}</dd>
                        </dl>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check text-blue-500 text-sm"></i>
                        </div>
                        <div class="ml-1 text-sm text-gray-600">
                            Across all levels
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-file-alt text-white text-lg"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Compliance Records</dt>
                            <dd class="text-2xl font-bold text-gray-900">{{ total_records }}</dd>
                        </dl>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-upload text-purple-500 text-sm"></i>
                        </div>
                        <div class="ml-1 text-sm text-gray-600">
                            Submitted artifacts
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-percentage text-white text-lg"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Avg. Compliance</dt>
                            <dd class="text-2xl font-bold text-gray-900">
                                {% if total_requirements > 0 and total_users > 0 %}
                                    {{ "%.1f"|format((total_records / (total_requirements * total_users)) * 100) }}%
                                {% else %}
                                    0.0%
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-chart-line text-orange-500 text-sm"></i>
                        </div>
                        <div class="ml-1 text-sm text-gray-600">
                            System-wide
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Level Compliance Chart -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Compliance by CMMC Level</h3>
            <canvas id="levelComplianceChart" width="400" height="300"></canvas>
        </div>

        <!-- Domain Distribution Chart -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Requirements by Domain</h3>
            <canvas id="domainChart" width="400" height="300"></canvas>
        </div>
    </div>

    <!-- Level Statistics Table -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">CMMC Level Statistics</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Possible</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Compliant</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Compliance Rate</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for level_num, stats in level_stats.items() %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-800 text-sm font-medium">
                                {{ level_num }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ stats.name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ stats.total_possible }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ stats.compliant }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ "%.1f"|format(stats.percentage) }}%
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-3">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ stats.percentage }}%"></div>
                                </div>
                                <span class="text-sm text-gray-500">{{ "%.0f"|format(stats.percentage) }}%</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-white shadow-lg rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Recent Compliance Activity</h3>
        </div>
        {% if recent_records %}
        <div class="divide-y divide-gray-200">
            {% for record in recent_records %}
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            {% if record.status == 'compliant' %}
                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check text-green-600 text-sm"></i>
                                </div>
                            {% elif record.status == 'in_progress' %}
                                <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-clock text-yellow-600 text-sm"></i>
                                </div>
                            {% elif record.status == 'non_compliant' %}
                                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-times text-red-600 text-sm"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">
                                {{ record.user.company }} - {{ record.requirement.requirement_id }}
                            </p>
                            <p class="text-sm text-gray-500">
                                {{ record.requirement.title }}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">{{ record.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                     {% if record.status == 'compliant' %}bg-green-100 text-green-800
                                     {% elif record.status == 'in_progress' %}bg-yellow-100 text-yellow-800
                                     {% elif record.status == 'non_compliant' %}bg-red-100 text-red-800
                                     {% endif %}">
                            {{ record.status.replace('_', ' ').title() }}
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="p-12 text-center">
            <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Recent Activity</h3>
            <p class="text-gray-500">No compliance records have been submitted yet.</p>
        </div>
        {% endif %}
    </div>

    <!-- Export Options -->
    <div class="mt-8 bg-white shadow-lg rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Export Reports</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="exportReport('compliance')" class="flex items-center justify-center p-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200">
                <i class="fas fa-file-csv text-green-600 mr-2"></i>
                Export Compliance Data (CSV)
            </button>
            
            <button onclick="exportReport('summary')" class="flex items-center justify-center p-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200">
                <i class="fas fa-file-pdf text-red-600 mr-2"></i>
                Generate Summary Report (PDF)
            </button>
            
            <button onclick="exportReport('analytics')" class="flex items-center justify-center p-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200">
                <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                Analytics Dashboard (Excel)
            </button>
        </div>
    </div>
</div>

<script>
// Level Compliance Chart
const levelCtx = document.getElementById('levelComplianceChart').getContext('2d');
const levelChart = new Chart(levelCtx, {
    type: 'bar',
    data: {
        labels: [{% for level_num in level_stats.keys() %}'Level {{ level_num }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Compliance Rate (%)',
            data: [{% for stats in level_stats.values() %}{{ stats.percentage }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(59, 130, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(139, 92, 246, 0.8)'
            ],
            borderColor: [
                'rgba(59, 130, 246, 1)',
                'rgba(16, 185, 129, 1)',
                'rgba(139, 92, 246, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Sample domain chart (would be populated with real data)
const domainCtx = document.getElementById('domainChart').getContext('2d');
const domainChart = new Chart(domainCtx, {
    type: 'doughnut',
    data: {
        labels: ['AC', 'AU', 'AT', 'CM', 'IA', 'IR', 'MA', 'MP', 'PS', 'PE', 'RA', 'CA', 'SC', 'SI'],
        datasets: [{
            data: [8, 6, 4, 10, 5, 7, 4, 6, 3, 8, 5, 9, 12, 7],
            backgroundColor: [
                '#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EF4444',
                '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6B7280',
                '#14B8A6', '#F472B6', '#A78BFA', '#FBBF24'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 15
                }
            }
        }
    }
});

function exportReport(type) {
    alert(`Export ${type} report functionality would generate and download the requested report.`);
}
</script>
{% endblock %}





