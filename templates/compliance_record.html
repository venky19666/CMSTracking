{% extends "base.html" %}

{% block title %}Update Compliance - {{ requirement.requirement_id }}{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center mb-4">
            <a href="{{ url_for('requirements') }}" class="text-gray-500 hover:text-gray-700 mr-4">
                <i class="fas fa-arrow-left text-lg"></i>
            </a>
            <h1 class="text-3xl font-bold text-gray-900">
                Update Compliance Record
            </h1>
        </div>
        <div class="flex items-center space-x-3">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                {{ requirement.requirement_id }}
            </span>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                Level {{ requirement.level.level_number }}
            </span>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                {{ requirement.domain.code }} - {{ requirement.domain.name }}
            </span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Form -->
        <div class="lg:col-span-2">
            <div class="bg-white shadow-lg rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Compliance Status</h3>
                </div>
                
                <form id="complianceForm" method="POST" enctype="multipart/form-data" class="p-6 space-y-6">
                    <input type="hidden" name="next" value="{{ next_url }}">
                    <!-- Current Status Display -->
                    {% if record %}
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Current Status</h4>
                        <div class="flex items-center space-x-2">
                            {% if record.status == 'compliant' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check mr-1"></i>Compliant
                                </span>
                            {% elif record.status == 'in_progress' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-clock mr-1"></i>In Progress
                                </span>
                            {% elif record.status == 'non_compliant' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <i class="fas fa-times mr-1"></i>Non-Compliant
                                </span>
                            {% endif %}
                            <span class="text-sm text-gray-500">Last updated: {{ record.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Status Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            Compliance Status <span class="text-red-500">*</span>
                        </label>
                        <div class="space-y-3">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 {% if record and record.status == 'compliant' %}border-green-500 bg-green-50{% else %}border-gray-300{% endif %}">
                                <input type="radio" name="status" value="compliant" 
                                       class="form-radio h-4 w-4 text-green-600 focus:ring-green-500" 
                                       {% if record and record.status == 'compliant' %}checked{% endif %}>
                                <div class="ml-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-check text-green-600 mr-2"></i>
                                        <span class="font-medium text-gray-900">Compliant</span>
                                    </div>
                                    <p class="text-sm text-gray-600">This requirement is fully implemented and meets all criteria.</p>
                                </div>
                            </label>

                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 {% if record and record.status == 'in_progress' %}border-yellow-500 bg-yellow-50{% else %}border-gray-300{% endif %}">
                                <input type="radio" name="status" value="in_progress" 
                                       class="form-radio h-4 w-4 text-yellow-600 focus:ring-yellow-500" 
                                       {% if record and record.status == 'in_progress' %}checked{% endif %}>
                                <div class="ml-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-clock text-yellow-600 mr-2"></i>
                                        <span class="font-medium text-gray-900">In Progress</span>
                                    </div>
                                    <p class="text-sm text-gray-600">Implementation is underway but not yet complete.</p>
                                </div>
                            </label>

                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 {% if record and record.status == 'non_compliant' %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %}">
                                <input type="radio" name="status" value="non_compliant" 
                                       class="form-radio h-4 w-4 text-red-600 focus:ring-red-500" 
                                       {% if record and record.status == 'non_compliant' %}checked{% endif %}>
                                <div class="ml-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-times text-red-600 mr-2"></i>
                                        <span class="font-medium text-gray-900">Non-Compliant</span>
                                    </div>
                                    <p class="text-sm text-gray-600">This requirement is not implemented or does not meet criteria.</p>
                                </div>
                            </label>

                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 {% if not record or record.status == 'not_started' %}border-gray-500 bg-gray-50{% else %}border-gray-300{% endif %}">
                                <input type="radio" name="status" value="not_started" 
                                       class="form-radio h-4 w-4 text-gray-600 focus:ring-gray-500" 
                                       {% if not record or record.status == 'not_started' %}checked{% endif %}>
                                <div class="ml-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-pause text-gray-600 mr-2"></i>
                                        <span class="font-medium text-gray-900">Not Started</span>
                                    </div>
                                    <p class="text-sm text-gray-600">Implementation has not yet begun.</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                            Implementation Notes
                        </label>
                        <textarea id="notes" name="notes" rows="6" 
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Document your implementation approach, evidence, challenges, or any additional notes...">{{ record.notes if record else '' }}</textarea>
                        <p class="text-xs text-gray-500 mt-1">These notes will help you track your implementation progress and provide context for auditors.</p>
                    </div>

                    <!-- File Upload Section -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-blue-800 mb-2">
                            <i class="fas fa-upload mr-1"></i>
                            Artifact Upload
                        </h4>
                        <div class="space-y-3">
                            <input type="file" name="artifact" accept=".pdf,.png,.jpg,.jpeg,.txt,.doc,.docx,.xlsx,.csv" class="block w-full text-sm text-gray-700">
                            
                            {% if record and record.artifact_path %}
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-file text-green-600 mr-2"></i>
                                        <span class="text-sm font-medium text-green-800">Current artifact:</span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm transition duration-200" href="{{ url_for('uploaded_file', filename=record.artifact_path.split('/')[-1]) }}" target="_blank">
                                            <i class="fas fa-external-link-alt mr-1"></i>View
                                        </a>
                                        <a class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm transition duration-200" href="{{ url_for('uploaded_file', filename=record.artifact_path.split('/')[-1]) }}" download>
                                            <i class="fas fa-download mr-1"></i>Download
                                        </a>
                                        <button type="button" onclick="deleteArtifact()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm transition duration-200">
                                            <i class="fas fa-trash mr-1"></i>Delete
                                        </button>
                                    </div>
                                </div>
                                
                                <p class="text-xs text-green-700 mb-3">File: {{ record.artifact_path.split('/')[-1] }}</p>
                                
                                <!-- File Preview -->
                                {% set file_ext = record.artifact_path.split('.')[-1].lower() %}
                                {% if file_ext in ['png', 'jpg', 'jpeg'] %}
                                    <div class="mt-3">
                                        <h5 class="text-xs font-medium text-green-800 mb-2">Preview:</h5>
                                        <img src="{{ url_for('uploaded_file', filename=record.artifact_path.split('/')[-1]) }}" alt="Artifact preview" class="max-w-full h-48 object-contain border border-gray-300 rounded">
                                    </div>
                                {% elif file_ext == 'pdf' %}
                                    <div class="mt-3">
                                        <h5 class="text-xs font-medium text-green-800 mb-2">PDF Preview:</h5>
                                        <iframe src="{{ url_for('uploaded_file', filename=record.artifact_path.split('/')[-1]) }}#toolbar=0" class="w-full h-64 border border-gray-300 rounded" title="PDF Preview"></iframe>
                                    </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                <p class="text-sm text-gray-700">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    No artifact uploaded yet. Accepted types: PDF, images, text, Office docs, CSV.
                                </p>
                            </div>
                            {% endif %}
                            
                            <!-- Hidden input for delete action -->
                            <input type="hidden" name="delete_artifact" id="delete_artifact" value="false">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                        <a href="{{ next_url or url_for('requirements', level=requirement.level_id) }}" 
                           class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-200">
                            Cancel
                        </a>
                        <button type="submit" 
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                            <i class="fas fa-save mr-2"></i>Update Compliance
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <!-- Requirement Details -->
            <div class="bg-white shadow-lg rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Requirement Details</h3>
                </div>
                <div class="p-6">
                    <h4 class="text-md font-semibold text-gray-900 mb-3">{{ requirement.title }}</h4>
                    <p class="text-sm text-gray-600 mb-4">{{ requirement.description }}</p>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Level:</span>
                            <span class="font-medium">{{ requirement.level.level_number }} - {{ requirement.level.name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Domain:</span>
                            <span class="font-medium">{{ requirement.domain.code }} - {{ requirement.domain.name }}</span>
                        </div>
                    </div>
                </div>
            </div>

            {% if requirement.assessment_objectives %}
            <div class="bg-white shadow-lg rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-bullseye text-green-600 mr-2"></i>
                        Assessment Objectives (NIST SP 800-171A)
                    </h3>
                </div>
                <div class="p-6 text-sm text-gray-700">
                    {% for line in requirement.assessment_objectives.split('\n') %}
                        {% if line.strip() %}
                            <div class="mb-1">{{ line }}</div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Implementation Guidance -->
            {% if requirement.guidance %}
            <div class="bg-white shadow-lg rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                        Implementation Guidance
                    </h3>
                </div>
                <div class="p-6">
                    <p class="text-sm text-gray-700 leading-relaxed">{{ requirement.guidance }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="bg-white shadow-lg rounded-lg mt-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Quick Actions</h3>
                </div>
                <div class="p-6 space-y-3">
                    <button type="button" onclick="markCompliant()" class="w-full flex items-center justify-center p-2 border border-green-300 rounded-lg hover:bg-green-50 transition duration-200 text-sm">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        Mark as Compliant
                    </button>
                    
                    <button type="button" onclick="markInProgress()" class="w-full flex items-center justify-center p-2 border border-yellow-300 rounded-lg hover:bg-yellow-50 transition duration-200 text-sm">
                        <i class="fas fa-clock text-yellow-600 mr-2"></i>
                        Mark as In Progress
                    </button>
                    
                    <a href="{{ url_for('requirements') }}" class="w-full flex items-center justify-center p-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200 text-sm">
                        <i class="fas fa-list text-gray-600 mr-2"></i>
                        Back to All Requirements
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function markCompliant() {
    document.querySelector('input[value="compliant"]').checked = true;
    document.getElementById('complianceForm').submit();
}

function markInProgress() {
    document.querySelector('input[value="in_progress"]').checked = true;
    document.getElementById('complianceForm').submit();
}

function deleteArtifact() {
    if (confirm('Are you sure you want to delete this artifact? This action cannot be undone.')) {
        document.getElementById('delete_artifact').value = 'true';
        document.getElementById('complianceForm').submit();
    }
}

// Auto-save draft functionality (could be enhanced)
let notesField = document.getElementById('notes');
let autoSaveTimeout;

notesField.addEventListener('input', function() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(function() {
        // Auto-save functionality could be implemented here
        console.log('Auto-saving draft...');
    }, 2000);
});
</script>
{% endblock %}





